{% extends "base.html" %}

{% block title %}Vocabulary - Simon Reader{% endblock %}

{% block content %}
<div class="library-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h2>My Vocabulary</h2>
    <div style="display: flex; gap: 1rem;">
        <a href="/dictionary/export" class="btn-primary"
            style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.9rem; background: transparent; border: 1px solid var(--border-brass); color: var(--text-primary);">üì§
            Export CSV</a>
        <a href="/quiz" class="btn-primary" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.9rem;">üß†
            Start Quiz</a>
    </div>
</div>

<div
    style="background: var(--bg-secondary); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color);">
    {% if words %}
    <table style="width: 100%; border-collapse: collapse; color: var(--text-primary);">
        <thead>
            <tr style="border-bottom: 1px solid var(--border-color); text-align: left;">
                <th style="padding: 1rem; width: 15%;">Word</th>
                <th style="padding: 1rem; width: 15%;">Pronunciation</th>
                <th style="padding: 1rem; width: 20%;">Translation</th>
                <th style="padding: 1rem; width: 30%;">Context</th>
                <th style="padding: 1rem; width: 10%;">Book</th>
                <th style="padding: 1rem; width: 10%;">Date</th>
                <th style="padding: 1rem; width: 5%;"></th> {# For delete button #}
            </tr>
        </thead>
        <tbody>
            {% for word in words %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 1rem; font-weight: 600; color: var(--accent-color);">{{ word.original_word }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ word.pronunciation or '-' }}</td>
                <td style="padding: 1rem;" title="{{ word.translated_word }}">{{ word.translated_word | truncate(100) }}
                </td>
                <td style="padding: 1rem; color: var(--text-secondary); font-style: italic;">
                    {% if word.context_sentence %}
                    {% if word.book_title and book_map and word.book_title in book_map %}
                    <a href="/reader/{{ book_map[word.book_title] }}?search={{ word.context_sentence | urlencode }}"
                        style="color: inherit; text-decoration: none; border-bottom: 1px dotted var(--text-secondary); cursor: pointer;"
                        title="Go to context in book"
                        onmouseover="this.style.color='var(--accent-color)'; this.style.borderBottomColor='var(--accent-color)'"
                        onmouseout="this.style.color='inherit'; this.style.borderBottomColor='var(--text-secondary)'">
                        "{{ word.context_sentence }}"
                    </a>
                    {% else %}
                    "{{ word.context_sentence }}"
                    {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td style="padding: 1rem; color: var(--text-secondary);">
                    {{ word.book_title or '-' }}
                </td>
                <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                    {{ word.created_at.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td style="padding: 1rem; text-align: center;">
                    <button class="delete-btn" data-id="{{ word.id }}"
                        style="background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.1rem;"
                        title="Delete Word">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
        <p style="margin-bottom: 1rem; font-size: 1.2rem;">No words saved yet.</p>
        <p>Read a book and save words to see them here!</p>
    </div>
    {% endif %}
</div>

<script>
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            if (!confirm('Are you sure you want to delete this word?')) return;

            const id = e.target.closest('button').dataset.id;
            try {
                const response = await fetch(`/dictionary/words/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Remove row
                    const row = e.target.closest('tr');
                    row.remove();

                    // Check if empty
                    const tbody = document.querySelector('tbody');
                    if (tbody && tbody.children.length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                } else {
                    alert('Failed to delete word');
                }
            } catch (err) {
                console.error(err);
                alert('Error deleting word');
            }
        });
    });
</script>
{% endblock %}